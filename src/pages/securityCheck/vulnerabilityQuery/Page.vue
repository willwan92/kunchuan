<template>
  <div class="page">
    <div class="section">
      <el-form
        :inline="true"
        :model="vulnerabilityQuery"
        class="demo-form-inline"
      >
        <el-form-item label="项目名称">
          <el-cascader
            :show-all-levels="false"
            :options="pjOptions"
            :props="{ expandTrigger: 'hover' }"
            filterable
            v-model="vulnerabilityQuery.name"
            @change="handlePjChange"
          ></el-cascader>
        </el-form-item>
        <el-form-item label="设备类型">
          <el-select
            v-model="vulnerabilityQuery.mold"
            placeholder="请选择"
            clearable=""
            @change="handleDevTypeChange"
          >
            <el-option
              v-for="(item, index) in device"
              :label="item.devtype"
              :value="item.devtype"
              :key="index"
            ></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="ip地址">
          <el-select v-model="vulnerabilityQuery.ip" 
            clearable="" placeholder="请选择">
            <el-option
              v-for="(item, index) in ListOfIp"
              :label="item.ip"
              :value="item.ip"
              :key="index"
            ></el-option>
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="onSubmit">查询</el-button>
        </el-form-item>
      </el-form>

      <el-table :data="tablesData" border row-class-name="table-row" v-loading="isLoading">
        <el-table-column
          prop="index"
          label="序号"
          width="100"
        ></el-table-column>
        <el-table-column prop="cveid" label="CVE ID"></el-table-column>
        <el-table-column prop="" label="漏洞名称">
          <template slot-scope="scope">
            <div class="table-cell">
              {{ scope.row.name }}
            </div>
          </template>
        </el-table-column>
        <el-table-column prop="level" label="级别"></el-table-column>
        <el-table-column
          prop="vulnerability_Type"
          label="漏洞类型"
        ></el-table-column>
        <el-table-column prop="CVSS" label="CVS分值"></el-table-column>
        <el-table-column prop="" label="描述">
          <template slot-scope="scope">
            <div class="table-cell">
              {{ scope.row.description }}
            </div>
          </template>
        </el-table-column>
        <el-table-column prop="" label="解决方案">
          <template slot-scope="scope">
            <div class="table-cell">
              {{ scope.row.solution }}
            </div>
          </template>
        </el-table-column>
        <el-table-column fixed="right" label="详细" width="100">
          <template slot-scope="scope">
            <el-button
              @click="getDetail(scope.row.ip, scope.row.cveid)"
              type="text"
              >[详细]</el-button
            >
          </template>
        </el-table-column>
      </el-table>
      <el-pagination
        v-if="tablesData.length > 0"
        background
        :current-page.sync="resData.page"
        :total="total"
        @current-change="handleCurrentChange"
        :page-size="resData.size"
        layout="prev, pager, next"
      >
      </el-pagination>
    </div>

    <el-dialog title="详细" :visible.sync="dialogFormVisible">
      <el-form :model="description" :disabled="true" v-loading="isLoadingDetail">
        <el-form-item label="CVE ID" :label-width="formLabelWidth">
          <el-input v-model="description.cveid" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="IP" :label-width="formLabelWidth">
          <el-input v-model="description.ip" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="漏洞名称" :label-width="formLabelWidth">
          <el-input v-model="description.name" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="漏洞级别" :label-width="formLabelWidth">
          <el-input v-model="description.level" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="漏洞类型" :label-width="formLabelWidth">
          <el-input
            v-model="description.vulnerability_Type"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="CVSS 分值" :label-width="formLabelWidth">
          <el-input v-model="description.CVSS" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="描述" :label-width="formLabelWidth">
          <el-input
            v-model="description.description"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="解决方案" :label-width="formLabelWidth">
          <el-input
            v-model="description.solution"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="CWE ID弱点类目" :label-width="formLabelWidth">
          <el-input v-model="description.cweid" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="# of Explots" :label-width="formLabelWidth">
          <el-input
            v-model="description.exploits"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="发布时间" :label-width="formLabelWidth">
          <el-input
            v-model="description.publish_date"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="修订时间" :label-width="formLabelWidth">
          <el-input
            v-model="description.update_date"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="访问级别" :label-width="formLabelWidth">
          <el-input
            v-model="description.gained_level"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="攻击路径" :label-width="formLabelWidth">
          <el-input v-model="description.access" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="攻击复杂度" :label-width="formLabelWidth">
          <el-input
            v-model="description.access_complexity"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="身份认证" :label-width="formLabelWidth">
          <el-input
            v-model="description.authentication"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="机密性影响" :label-width="formLabelWidth">
          <el-input
            v-model="description.confidentiality_impact"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="完整性影响" :label-width="formLabelWidth">
          <el-input
            v-model="description.integrity_impact"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="可用性影响" :label-width="formLabelWidth">
          <el-input
            v-model="description.availability_impact"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="受影响的产品及版本" :label-width="formLabelWidth">
          <el-input
            v-model="description.product_name"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="产品类型" :label-width="formLabelWidth">
          <el-input
            v-model="description.product_type"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="参考" :label-width="formLabelWidth">
          <el-input
            v-model="description.references"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="相关模块" :label-width="formLabelWidth">
          <el-input
            v-model="description.metasploit"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="漏洞条件" :label-width="formLabelWidth">
          <el-input
            v-model="description.conditions"
            autocomplete="off"
          ></el-input>
        </el-form-item>
        <el-form-item label="厂家" :label-width="formLabelWidth">
          <el-input v-model="description.vendors" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
    </el-dialog>
  </div>
</template>

<script>
import { getCascaderOptions, formatTreeData } from "../../../common/utils";
export default {
  data() {
    return {
      isLoading: false,
      isLoadingDetail: false,
      resData: {
        page: 1,
        size: 10
      },
      total: 0,
      pjOptions: null,
      pjValue: [],
      activeName: "first",
      vulnerabilityQuery: {
        name: [],
        mold: "",
        ip: ""
      },
      device: [], // 设备类型下拉列表
      ListOfIp: [], // ip下拉列表
      tablesData: [],
      dialogFormVisible: false,
      formLabelWidth: "120px",
      description: {}
    };
  },
  created() {
    this.fetchPjTreeData();
  },
  computed: {
    getPjId() {
      let id;
      if (this.vulnerabilityQuery.name && this.vulnerabilityQuery.name[0]) {
        id = this.vulnerabilityQuery.name.slice(-1)[0];
      } else {
        id = null;
      }
      return id;
    }
  },
  methods: {
    handleDevTypeChange() {
      this.vulnerabilityQuery.ip = '';
      this.getIp();
    },
    handlePjChange() {
      this.vulnerabilityQuery.mold = '';
      this.vulnerabilityQuery.ip = '';
      this.getDevice();
      this.getIp();
    },
    /**
     * 获取项目名称
     * @returns {Promise<void>}
     */
    async fetchPjTreeData() {
      const roleId = sessionStorage.getItem("roleId");

      const data = await this.fetch({
        url: "/projectInfo/getEnableRole",
        params: {
          enablerole: `(${roleId})`
        },
        vm: this
      });

      const treeData = formatTreeData(data, 0);

      this.pjOptions = getCascaderOptions({
        arr: treeData,
        label: "pjname",
        value: "id",
        filter: "isleaf"
      });
    },
    /**
     * 获取设备名称
     * @param val
     * @returns {Promise<void>}
     */
    async getDevice() {
      let pjId = this.getPjId;
      await this.fetchFuzz({
        url: "/fuzz/page/view/station!selectDevTypeByName.action",
        params: { pjid: pjId },
        vm: this
      }).then(res => {
        this.device = res;
      });
    },
    /**
     * 查询ip
     * @returns {Promise<void>}
     */
    async getIp() {
      let pjId = this.getPjId;
      let devtype = this.vulnerabilityQuery.mold;
      await this.fetchFuzz({
        url: "/fuzz/page/view/station!selectipByPjidAndDev.action",
        params: { pjid: pjId, devtype },
        vm: this
      }).then(res => {
        this.ListOfIp = res;
      });
    },
    /**
     * 漏洞查询
     * @returns {Promise<void>}
     */
    async onSubmit() {
      if (
        this.vulnerabilityQuery.name.length === 0
      ) {
        this.$message.error("请选择项目");
        return;
      }

      let pjid = this.getPjId;
      let devtype =
        this.vulnerabilityQuery.mold;
      let ip =
        this.vulnerabilityQuery.ip ? this.vulnerabilityQuery.ip : 0;


      this.tablesData = [];
      this.isLoading = true;

      const res = await this.fetchFuzz({
        url: "/fuzz/page/view/station!uploaddata.action",
        params: {
          start2: parseInt(this.resData.page - 1) * 10,
          t: Math.random(),
          pjid,
          devtype,
          ip
        },
        vm: this
      });

      this.isLoading = false;

      if (res && res.data && res.data[0]) {
        this.total = res.total;
        this.tablesData = res.data.map(item => {
          return {
            index: item[0],
            ip: item[1],
            cveid: item[2],
            name: item[3],
            level: item[4],
            vulnerability_Type: item[5],
            CVSS: item[6],
            description: item[7],
            solution: item[8]
          };
        });
      }
    },
    /**
     * 每行详情数据
     * @param ip ip
     * @param cveId cveId
     */
    async getDetail(ip, cveId) {
      this.dialogFormVisible = true;
      this.isLoadingDetail = true;

      this.fetchFuzz({
        url: "/fuzz/page/view/station!selectStationDetail.action",
        params: {
          ip: ip,
          cveid: cveId
        },
        vm: this
      }).then(res => {
        this.isLoadingDetail = false;
        const data = res.data;
        if (data && data[0]) {
          this.description = data[0];
        }
      });
    },
    /**
     * 分页数据查询
     */
    handleCurrentChange() {
      this.resData.page = this.resData.page + 1;
      this.onSubmit();
    }
  }
};
</script>
<style scoped lang="less">
.page {
  .section {
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 5px;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    margin-bottom: 30px;
    &:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      -webkit-box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
  }
}

.table-cell {
  height: 100px;
  overflow: auto;
}
</style>
