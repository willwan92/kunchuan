<template>
	<div class="goodsPage">
		<div class="goodsTop">
      <el-tabs v-model="activeName" type="card">
        <el-tab-pane label="漏洞查询" name="first">
          <template>
            <el-form :inline="true" :model="vulnerabilityQuery" class="demo-form-inline">
              <el-form-item label="项目名称">
                <el-cascader :show-all-levels="false" :options="pjOptions" :props="{ expandTrigger: 'hover' }"
                  filterable v-model="vulnerabilityQuery.name" @change="getDevice"></el-cascader>
              </el-form-item>
              <el-form-item label="设备类型">
                <el-select v-model="vulnerabilityQuery.mold" placeholder="--请选择--" @change="getIp">
                  <el-option v-for="(item, index) in device" :label="item.devtype" :value="item.devtype" :key="index"></el-option>
                </el-select>
              </el-form-item>
              <el-form-item label="ip地址">
                <el-select v-model="vulnerabilityQuery.ip" placeholder="--请选择--">
                  <el-option v-for="(item, index) in ListOfIp" :label="item.ip" :value="item.ip" :key="index"></el-option>
                </el-select>
              </el-form-item>
              <el-form-item>
                <el-button type="primary" @click="onSubmit">查询</el-button><slot>(带有*为必选项)</slot>
              </el-form-item>
            </el-form>
          </template>
        </el-tab-pane>
      </el-tabs>
		</div>
    <el-divider></el-divider>
    <div style="width: 100%;text-align: center;">
      <!--<app-table :tableTitles="tablesHeader" :tableData="tablesData"></app-table>-->
      <el-table :data="tablesData" style="width: 100%" border>
        <el-table-column type="index" width="50"></el-table-column>
        <!--<el-table-column prop="ip" label="IP"></el-table-column>-->
        <el-table-column prop="cveid" label="CVE ID" width="150"></el-table-column>
        <el-table-column prop="name" label="漏洞名称"></el-table-column>
        <el-table-column prop="level" label="级别" width="80"></el-table-column>
        <el-table-column prop="vulnerability_Type" label="漏洞类型" width="80"></el-table-column>
        <el-table-column prop="CVSS" label="CVS分值" width="50"></el-table-column>
        <el-table-column prop="description" label="描述"></el-table-column>
        <el-table-column prop="solution" label="解决方案"></el-table-column>
        <el-table-column fixed="right" label="详细" width="100">
          <template slot-scope="scope">
            <el-button @click="getDetail(scope.row.ip, scope.row.cveid)" type="text" size="small">[详细]</el-button>
          </template>
        </el-table-column>
      </el-table>
      <el-pagination v-if="tablesData.length > 0" background :current-page.sync="resData.page" :total="total"
                     @current-change="handleCurrentChange" :page-size="resData.size" layout="prev, pager, next">
      </el-pagination>
    </div>
    <el-dialog title="详细" :visible.sync="dialogFormVisible">
      <el-form :model="description">
        <el-form-item label="CVE ID" :label-width="formLabelWidth">
          <el-input v-model="description.cveid" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="IP" :label-width="formLabelWidth">
          <el-input v-model="description.ip" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="漏洞名称" :label-width="formLabelWidth">
          <el-input v-model="description.name" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="漏洞级别" :label-width="formLabelWidth">
          <el-input v-model="description.level" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="漏洞类型" :label-width="formLabelWidth">
          <el-input v-model="description.vulnerability_Type" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="CVSS 分值" :label-width="formLabelWidth">
          <el-input v-model="description.CVSS" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="描述" :label-width="formLabelWidth">
          <el-input v-model="description.description" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="解决方案" :label-width="formLabelWidth">
          <el-input v-model="description.solution" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="CWE ID弱点类目" :label-width="formLabelWidth">
          <el-input v-model="description.cweid" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="# of Explots" :label-width="formLabelWidth">
          <el-input v-model="description.exploits" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="发布时间" :label-width="formLabelWidth">
          <el-input v-model="description.publish_date" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="修订时间" :label-width="formLabelWidth">
          <el-input v-model="description.update_date" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="访问级别" :label-width="formLabelWidth">
          <el-input v-model="description.gained_level" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="攻击路径" :label-width="formLabelWidth">
          <el-input v-model="description.access" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="攻击复杂度" :label-width="formLabelWidth">
          <el-input v-model="description.access_complexity" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="身份认证" :label-width="formLabelWidth">
          <el-input v-model="description.authentication" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="机密性影响" :label-width="formLabelWidth">
          <el-input v-model="description.confidentiality_impact" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="完整性影响" :label-width="formLabelWidth">
          <el-input v-model="description.integrity_impact" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="可用性影响" :label-width="formLabelWidth">
          <el-input v-model="description.availability_impact" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="受影响的产品及版本" :label-width="formLabelWidth">
          <el-input v-model="description.product_name" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="产品类型" :label-width="formLabelWidth">
          <el-input v-model="description.product_type" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="参考" :label-width="formLabelWidth">
          <el-input v-model="description.references" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="相关模块" :label-width="formLabelWidth">
          <el-input v-model="description.metasploit" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="漏洞条件" :label-width="formLabelWidth">
          <el-input v-model="description.conditions" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="厂家" :label-width="formLabelWidth">
          <el-input v-model="description.vendors" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
    </el-dialog>
	</div>
</template>

<script>
  import { getCascaderOptions } from "../../../common/utils";
  import appTable from '../../../components/AppTable/index'
	export default {
		data() {
			return {
        resData: {
          page: 1, size: 10
        },
        total: 0,
        pjOptions: null,
        pjValue: [],
			  activeName: 'first',
        vulnerabilityQuery: {
			    name: [],
          mold: '--请选择--',
          ip: '--请选择--'
        },
        device: [], // 设备类型下拉列表
        ListOfIp: [], // ip下拉列表
        tablesData: [],
        dialogFormVisible: false,
        formLabelWidth: '120px',
        description: {}
			}
		},
    components: {appTable},
    created () {
      this.fetchPjTreeData()
    },
    computed: {
      getPjId() {
        let id;
        if (this.pjValue && this.pjValue[0]) {
          id = this.pjValue.slice(-1)[0];
        } else {
          id = null;
        }
        return id;
      }
    },
    methods: {
      /**
       * 获取项目名称
       * @returns {Promise<void>}
       */
      async fetchPjTreeData() {
        const { data } = await this.fetch({
          url: "/porject/getProjectList",
          vm: this
        });

        this.pjOptions = getCascaderOptions({
          arr: data,
          label: "pjname",
          value: "id",
          filter: 'isleaf'
        });
      },
      /**
       * 获取设备名称
       * @param val
       * @returns {Promise<void>}
       */
      async getDevice () {
        let pjId = this.getPjId
        await this.fetchFuzz({
          url: "/fuzz/page/view/station!selectDevTypeByName.action",
          params: {pjid: pjId},
          vm: this
        }).then(res => {
          this.device = res
          this.device.unshift({devtype: '--请选择--'})
        })
      },
      /**
       * 查询ip
       * @returns {Promise<void>}
       */
      async getIp () {
        let pjId = this.getPjId
        let devtype = this.vulnerabilityQuery.mold
        await this.fetchFuzz({url: "/fuzz/page/view/station!selectipByPjidAndDev.action", params: {pjid: pjId, devtype}, vm: this}).then(res => {
          this.ListOfIp = res
          this.ListOfIp.unshift({ip: '--请选择--'})
        })
      },
      /**
       * 漏洞查询
       * @returns {Promise<void>}
       */
      async onSubmit () {
        if (this.vulnerabilityQuery.name.length === 0 || this.vulnerabilityQuery.ip === '' || this.vulnerabilityQuery.mold === '') {
          this.$message.error('请选择完整')
        } else {
          let pjid = this.getPjId
          let devtype = this.vulnerabilityQuery.mold !== '--请选择--' ? this.vulnerabilityQuery.mold : '0'
          let ip = this.vulnerabilityQuery.ip !== '--请选择--' ? this.vulnerabilityQuery.ip : '0'
          await this.fetchFuzz({url: '/fuzz/page/view/station!uploaddata.action',
            params: {start2: this.resData.page, t: Math.random(), pjid, devtype, ip}, vm: this
          }).then(res => {
            this.tablesData = res.data
            this.total = res.total
          })
          console.log(this.tablesData, 'data')
        }
      },
      /**
       * 每行详情数据
       * @param ip ip
       * @param cveId cveId
       */
      async getDetail (ip , cveId) {
        console.log(ip, cveId, 'detail')
        await this.fetchFuzz({url: "/fuzz/page/view/station!selectStationDetail.action", params: {
            ip: ip, cveid: cveId}, vm: this
        }).then(res => {
          this.description = res
        })
        console.log(this.description, 'this.description')
      },
      /**
       * 分页数据查询
       */
      handleCurrentChange () {
        this.resData.page = this.resData.page + 1
        this.onSubmit()
      }
    }
	}
</script>
<style scoped lang="less">
.goodsPage {
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 5px;
  background: #fff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
  -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
  margin-bottom: 30px;
  &:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    -webkit-box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }
  .goodsTop{
    margin-top: 20px;
  }
}
</style>
